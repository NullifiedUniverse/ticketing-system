<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ticket Scanner</title>
    
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/html5-qrcode.min.js" onerror="this.src='https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js'"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        /* Optimized Dark Theme */
        :root {
            --color-primary: #6366f1; /* Indigo 500 */
            --color-success: #22c55e; /* Green 500 */
            --color-error: #ef4444; /* Red 500 */
            --color-warning: #eab308; /* Yellow 500 */
            --glass-bg: rgba(20, 20, 20, 0.6);
            --glass-border: rgba(255,255,255,0.1);
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background: black; 
            overflow: hidden; 
            color: white;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Fullscreen Camera with Center Crop */
        #reader { 
            position: fixed; inset: 0; z-index: 0; background: black; 
        }
        #reader video { 
            width: 100% !important; height: 100% !important; 
            object-fit: cover !important; 
        }

        /* 
           Perfectly Centered Overlay
           Uses absolute positioning with transform to ensure it's always center
           Max size ensures it doesn't overflow on small phones
        */
        .scanner-overlay {
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%);
            
            /* Responsive Size: 70% of smaller dimension */
            width: 70vmin; 
            height: 70vmin;
            
            /* Limits */
            max-width: 500px; 
            max-height: 500px;
            
            border-radius: 24px;
            
            /* The "Darken Everything Else" trick */
            box-shadow: 0 0 0 200vmax rgba(0,0,0,0.7); 
            
            border: 2px solid rgba(255,255,255,0.4);
            z-index: 10;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .scanner-overlay.active { 
            border-color: var(--color-success); 
            box-shadow: 0 0 0 200vmax rgba(0,0,0,0.7), 0 0 30px rgba(34, 197, 94, 0.4); 
            transform: translate(-50%, -50%) scale(1.02); 
        }
        
        .scanner-overlay.error { 
            border-color: var(--color-error); 
            box-shadow: 0 0 0 200vmax rgba(0,0,0,0.7), 0 0 30px rgba(239, 68, 68, 0.4); 
        }

        /* Laser Animation - Smoother */
        .laser {
            position: absolute; 
            width: 100%; 
            height: 2px; 
            background: var(--color-primary);
            box-shadow: 0 0 15px var(--color-primary); 
            top: 50%;
            opacity: 0.6;
            animation: scan 2.5s infinite ease-in-out;
        }
        
        @keyframes scan { 
            0% { transform: translateY(-20vmin) scaleX(0.9); opacity: 0; } 
            10% { opacity: 1; }
            50% { transform: translateY(0) scaleX(1); opacity: 0.5; } 
            90% { opacity: 1; }
            100% { transform: translateY(20vmin) scaleX(0.9); opacity: 0; } 
        }

        /* Modern Glass UI */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
        }

        /* Popups */
        .popup-enter {
            animation: slideUp 0.4s cubic-bezier(0.19, 1, 0.22, 1) forwards;
        }
        @keyframes slideUp { 
            from { transform: translateY(120%); opacity: 0; } 
            to { transform: translateY(0); opacity: 1; } 
        }
    </style>
</head>
<body>

    <!-- Camera Container -->
    <div id="reader"></div>

    <!-- Visual Overlay -->
    <div class="scanner-overlay" id="scan-box">
        <div class="laser"></div>
        <!-- Stylish Corners -->
        <div class="absolute top-0 left-0 w-10 h-10 border-t-[5px] border-l-[5px] border-white rounded-tl-2xl -mt-1 -ml-1"></div>
        <div class="absolute top-0 right-0 w-10 h-10 border-t-[5px] border-r-[5px] border-white rounded-tr-2xl -mt-1 -mr-1"></div>
        <div class="absolute bottom-0 left-0 w-10 h-10 border-b-[5px] border-l-[5px] border-white rounded-bl-2xl -mb-1 -ml-1"></div>
        <div class="absolute bottom-0 right-0 w-10 h-10 border-b-[5px] border-r-[5px] border-white rounded-br-2xl -mb-1 -mr-1"></div>
    </div>

    <!-- UI Overlay Layer (Click-through except buttons) -->
    <div class="fixed inset-0 z-20 flex flex-col p-safe-area pointer-events-none">
        
        <!-- Top Navigation Bar -->
        <div class="flex justify-between items-start p-4 pointer-events-auto">
            
            <!-- Status Badge -->
            <div class="glass px-4 py-2.5 rounded-full flex items-center gap-3 shadow-lg transition-all" id="status-badge">
                <div id="status-dot" class="w-2.5 h-2.5 rounded-full bg-gray-500 transition-colors duration-300"></div>
                <div class="flex flex-col leading-none">
                    <span class="text-[9px] text-gray-400 font-bold uppercase tracking-wider mb-0.5">Event</span>
                    <span id="event-name" class="text-xs font-bold text-white truncate max-w-[120px]">Not Linked</span>
                </div>
            </div>

            <!-- Settings / Reset -->
            <button onclick="resetApp()" class="glass w-10 h-10 rounded-full flex items-center justify-center text-white/70 hover:text-white hover:bg-white/10 active:scale-95 transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
            </button>
        </div>

        <!-- Result Card Area (Bottom-Center) -->
        <div id="result-area" class="mt-auto px-4 pb-4 hidden flex justify-center w-full">
            <div class="glass rounded-[2rem] p-6 w-full max-w-sm text-center shadow-2xl border-l-[6px] popup-enter relative overflow-hidden" id="result-card">
                <!-- Background Glow -->
                <div class="absolute inset-0 bg-gradient-to-br from-white/5 to-transparent opacity-50 pointer-events-none"></div>
                
                <div id="result-icon" class="text-5xl mb-3 transform transition-transform hover:scale-110">âœ…</div>
                <h1 id="result-name" class="text-2xl font-black text-white leading-tight mb-1 break-words tracking-tight">Attendee Name</h1>
                <p id="result-msg" class="text-xs font-bold text-white/70 uppercase tracking-widest">Access Granted</p>
            </div>
        </div>

        <!-- Controls Area (Bottom) -->
        <div class="pointer-events-auto px-4 pb-6 pt-2" id="controls-area">
            
            <!-- Toggle Switch (Check-In / Check-Out) -->
            <div id="mode-toggle" class="glass p-1.5 rounded-2xl flex hidden mb-3">
                <button onclick="setMode('check-in')" id="btn-in" class="flex-1 py-3 rounded-xl text-sm font-extrabold shadow-lg transition-all relative overflow-hidden">
                    Check In
                </button>
                <button onclick="setMode('check-out')" id="btn-out" class="flex-1 py-3 rounded-xl text-sm font-extrabold transition-all relative overflow-hidden">
                    Check Out
                </button>
            </div>

            <!-- Initialization Button -->
            <button id="start-btn" onclick="startScanner()" class="w-full bg-white hover:bg-gray-100 active:bg-gray-200 text-black font-black text-lg py-4 rounded-2xl shadow-xl active:scale-95 transition-all disabled:opacity-50 disabled:scale-100">
                Initialize Camera
            </button>
        </div>
    </div>

    <script>
        let html5QrCode;
        let config = null;
        let mode = 'check-in';
        let isProcessing = false;
        let isCameraRunning = false;

        // Preload Audio
        const audioSuccess = new Audio('data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU'); // Placeholder
        // Real implementation would use distinct short beeps

        window.onload = () => {
            // LibraryShim
            if (typeof Html5QrCode === 'undefined' && window.__Html5QrcodeLibrary__) {
                window.Html5QrCode = window.__Html5QrcodeLibrary__.Html5Qrcode;
            }
            
            if (typeof Html5QrCode !== 'undefined') {
                document.getElementById('start-btn').innerText = "Tap to Start";
                loadConfig();
            } else {
                const btn = document.getElementById('start-btn');
                btn.innerText = "Library Error";
                btn.classList.add('bg-red-500', 'text-white');
            }
        };

        function loadConfig() {
            try {
                const saved = localStorage.getItem('ticketScannerConfig');
                if (saved) {
                    config = JSON.parse(saved);
                    updateUI(true);
                    // Silent Warmup
                    fetch(`${config.apiBaseUrl}/api/scanner/warmup/${config.eventId}`, {
                        headers: { 'Authorization': `Bearer ${config.token}` },
                        keepalive: true
                    }).catch(console.warn);
                }
            } catch(e) { 
                localStorage.removeItem('ticketScannerConfig'); 
            }
        }

        async function startScanner() {
            const btn = document.getElementById('start-btn');
            if (isCameraRunning) return;

            btn.innerText = "Accessing Camera...";
            btn.disabled = true;

            try {
                // 1. Request Permissions
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                stream.getTracks().forEach(t => t.stop()); // Stop initial test stream

                // 2. Init Lib
                html5QrCode = new Html5QrCode("reader");
                
                // 3. Calculate optimal box size relative to screen
                // We want the scanning region to match the CSS overlay exactly
                // CSS is 70vmin (70% of min dimension)
                const qrBoxFunction = (viewfinderWidth, viewfinderHeight) => {
                    const minEdge = Math.min(viewfinderWidth, viewfinderHeight);
                    const boxSize = Math.floor(minEdge * 0.70);
                    return { width: boxSize, height: boxSize };
                };

                // 4. Start
                await html5QrCode.start(
                    { facingMode: "environment" },
                    { 
                        fps: 30, // Higher FPS for smoother feel
                        qrbox: qrBoxFunction,
                        aspectRatio: window.innerWidth / window.innerHeight,
                        disableFlip: false,
                        formatsToSupport: [ 0 ] // 0 = QR_CODE only (Faster)
                    },
                    onScan,
                    (err) => { /* Ignore frame errors */ }
                );

                isCameraRunning = true;
                btn.classList.add('hidden'); // Hide button
                document.getElementById('scan-box').style.opacity = "1"; 

            } catch (err) {
                console.error(err);
                alert("Camera Error: " + (err.message || "Permission Denied"));
                btn.disabled = false;
                btn.innerText = "Retry Camera";
                btn.classList.add('bg-red-100', 'text-red-900');
            }
        }

        async function onScan(text) {
            if (isProcessing) return;
            isProcessing = true;

            // Immediate Feedback
            try { html5QrCode.pause(true); } catch(e){}
            if (navigator.vibrate) navigator.vibrate(40);
            
            const box = document.getElementById('scan-box');
            box.classList.add('active'); // Visual flash

            if (!config) {
                await handleSetup(text);
            } else {
                await handleTicket(text);
            }
        }

        async function handleSetup(text) {
            try {
                const data = JSON.parse(text);
                if (!data.eventId || !data.apiBaseUrl) throw new Error("Missing Config");
                
                config = data;
                localStorage.setItem('ticketScannerConfig', JSON.stringify(config));
                
                updateUI(true);
                showResult('success', 'Linked!', config.eventId);
                
                // Force reload to apply new API Base URL logic if needed, 
                // but for SPA feel we just reset state
                
            } catch (e) {
                showResult('error', 'Invalid Setup QR', 'Scan the Dashboard QR');
            } finally {
                resetState(1500);
            }
        }

        async function handleTicket(id) {
            showResult('loading', 'Checking...', 'Verifying ID');

            try {
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 4000); // 4s Timeout

                const res = await fetch(`${config.apiBaseUrl}/api/scanner/update-ticket-status/${config.eventId}/${id}`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json', 
                        'Authorization': `Bearer ${config.token}` 
                    },
                    body: JSON.stringify({ action: mode }),
                    signal: controller.signal
                });
                clearTimeout(timeout);
                
                const data = await res.json();
                
                if (!res.ok) throw new Error(data.message || "Scan Failed");

                // Double-Vibrate for success
                if(navigator.vibrate) navigator.vibrate([50, 50, 50]);
                
                showResult('success', data.data?.attendeeName || "Valid Ticket", data.message);

            } catch (e) {
                // Long vibrate for error
                if(navigator.vibrate) navigator.vibrate(300);
                
                const isCheckedIn = e.message.toLowerCase().includes('already checked');
                const isLeave = e.message.toLowerCase().includes('on leave');
                
                if (isCheckedIn) {
                    showResult('warning', 'Already In', 'Ticket Used');
                } else {
                    showResult('error', 'Invalid', e.message || "Unknown Error");
                }
            } finally {
                resetState(isProcessing ? 1200 : 500);
            }
        }

        function showResult(type, title, subtitle) {
            const area = document.getElementById('result-area');
            const card = document.getElementById('result-card');
            const icon = document.getElementById('result-icon');
            const name = document.getElementById('result-name');
            const msg = document.getElementById('result-msg');
            const box = document.getElementById('scan-box');

            area.classList.remove('hidden');
            
            // Configs
            const styles = {
                success: { 
                    bg: 'bg-green-600/90', 
                    border: 'border-green-400', 
                    icon: 'âœ¨' 
                },
                error: { 
                    bg: 'bg-red-600/90', 
                    border: 'border-red-400', 
                    icon: 'ðŸ›‘' 
                },
                warning: { 
                    bg: 'bg-yellow-600/90', 
                    border: 'border-yellow-400', 
                    icon: 'âš ï¸' 
                },
                loading: { 
                    bg: 'bg-gray-800/90', 
                    border: 'border-blue-400', 
                    icon: 'â³' 
                }
            };
            
            const s = styles[type] || styles.loading;
            
            // Apply Styles
            // Reset classes first
            card.className = `glass rounded-[2rem] p-6 w-full max-w-sm text-center shadow-2xl border-l-[8px] popup-enter relative overflow-hidden ${s.bg} ${s.border}`;
            
            icon.innerText = s.icon;
            name.innerText = title;
            msg.innerText = subtitle;

            // Update Overlay Box Color
            if (type === 'error') box.classList.add('error');
            if (type === 'success') box.classList.add('active');
        }

        function resetState(delay) {
            setTimeout(() => {
                isProcessing = false;
                document.getElementById('result-area').classList.add('hidden');
                const box = document.getElementById('scan-box');
                box.classList.remove('active', 'error');
                
                // Resume Camera
                if (isCameraRunning) {
                    try { html5QrCode.resume(); } catch(e){}
                }
            }, delay);
        }

        function updateUI(isConfigured) {
            const badge = document.getElementById('status-badge');
            const dot = document.getElementById('status-dot');
            const text = document.getElementById('event-name');
            const toggle = document.getElementById('mode-toggle');

            if (isConfigured) {
                text.innerText = config.eventId;
                dot.classList.remove('bg-gray-500');
                dot.classList.add('bg-green-400', 'animate-pulse');
                toggle.classList.remove('hidden');
                badge.classList.add('border-green-500/30');
            } else {
                text.innerText = "Not Linked";
                dot.className = "w-2.5 h-2.5 rounded-full bg-red-500 animate-pulse";
                toggle.classList.add('hidden');
            }
        }

        function setMode(m) {
            mode = m;
            const btnIn = document.getElementById('btn-in');
            const btnOut = document.getElementById('btn-out');
            
            const activeClass = "bg-indigo-600 text-white shadow-xl scale-105 z-10";
            const inactiveClass = "text-gray-400 hover:text-white hover:bg-white/5";
            
            if (mode === 'check-in') {
                btnIn.className = `flex-1 py-3 rounded-xl text-sm font-extrabold transition-all ${activeClass}`;
                btnOut.className = `flex-1 py-3 rounded-xl text-sm font-extrabold transition-all ${inactiveClass}`;
            } else {
                btnIn.className = `flex-1 py-3 rounded-xl text-sm font-extrabold transition-all ${inactiveClass}`;
                btnOut.className = `flex-1 py-3 rounded-xl text-sm font-extrabold transition-all bg-pink-600 text-white shadow-xl scale-105 z-10`;
            }
        }

        function resetApp() {
            if (confirm("Unlink scanner from current event?")) {
                localStorage.removeItem('ticketScannerConfig');
                location.reload();
            }
        }
    </script>
</body>
</html>