<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ticket Scanner</title>
    
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/html5-qrcode.min.js" onerror="this.src='https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js'"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background: black; overflow: hidden; }
        
        /* Fullscreen Camera */
        #reader { position: fixed; inset: 0; z-index: 0; background: black; }
        #reader video { 
            width: 100% !important; height: 100% !important; 
            object-fit: cover !important; 
        }

        /* Scanner Overlay (The Box) */
        .scanner-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 70vw; height: 70vw;
            max-width: 70vh; max-height: 70vh;
            border-radius: 20px;
            box-shadow: 0 0 0 100vmax rgba(0,0,0,0.6); /* Dim everything else */
            border: 2px solid rgba(255,255,255,0.5);
            z-index: 10;
            transition: all 0.2s ease-out;
        }
        
        .scanner-overlay.active { border-color: #4ade80; box-shadow: 0 0 0 100vmax rgba(0,0,0,0.6), 0 0 50px rgba(74, 222, 128, 0.5); transform: translate(-50%, -50%) scale(1.05); }
        .scanner-overlay.error { border-color: #ef4444; box-shadow: 0 0 0 100vmax rgba(0,0,0,0.6), 0 0 50px rgba(239, 68, 68, 0.5); }

        /* Laser Animation */
        .laser {
            position: absolute; width: 100%; height: 2px; background: #6366f1;
            box-shadow: 0 0 15px #6366f1; top: 50%;
            animation: scan 2s infinite ease-in-out;
        }
        @keyframes scan { 0% { transform: translateY(-15vh) scaleX(0.8); opacity: 0; } 50% { transform: translateY(0) scaleX(1); opacity: 1; } 100% { transform: translateY(15vh) scaleX(0.8); opacity: 0; } }

        /* Glass UI */
        .glass {
            background: rgba(20, 20, 20, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* Result Popup */
        .result-popup {
            animation: popUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
        @keyframes popUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>

    <div id="reader"></div>

    <!-- Visual Overlay (Aligned with JS Logic) -->
    <div class="scanner-overlay" id="scan-box">
        <div class="laser"></div>
        <!-- Corner Accents -->
        <div class="absolute top-0 left-0 w-8 h-8 border-t-4 border-l-4 border-white rounded-tl-2xl -mt-1 -ml-1"></div>
        <div class="absolute top-0 right-0 w-8 h-8 border-t-4 border-r-4 border-white rounded-tr-2xl -mt-1 -mr-1"></div>
        <div class="absolute bottom-0 left-0 w-8 h-8 border-b-4 border-l-4 border-white rounded-bl-2xl -mb-1 -ml-1"></div>
        <div class="absolute bottom-0 right-0 w-8 h-8 border-b-4 border-r-4 border-white rounded-br-2xl -mb-1 -mr-1"></div>
    </div>

    <!-- UI Layer -->
    <div class="fixed inset-0 z-20 flex flex-col p-6 pointer-events-none">
        
        <!-- Top Bar -->
        <div class="flex justify-between items-center pointer-events-auto">
            <div class="glass px-4 py-2 rounded-full flex items-center gap-3 shadow-lg">
                <div id="status-dot" class="w-2.5 h-2.5 rounded-full bg-red-500 animate-pulse"></div>
                <div class="flex flex-col">
                    <span class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Event</span>
                    <span id="event-name" class="text-xs font-bold text-white">Setup Required</span>
                </div>
            </div>
            <button onclick="resetApp()" class="glass w-10 h-10 rounded-full flex items-center justify-center text-white/70 hover:text-white active:scale-95 transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
            </button>
        </div>

        <!-- Result Display (Large Name) -->
        <div id="result-area" class="mt-auto mb-4 hidden">
            <div class="glass rounded-3xl p-6 text-center shadow-2xl border-l-8 result-popup" id="result-card">
                <div id="result-icon" class="text-5xl mb-2">✅</div>
                <h1 id="result-name" class="text-3xl font-black text-white leading-tight mb-1 break-words">Attendee Name</h1>
                <p id="result-msg" class="text-sm text-gray-300 font-medium uppercase tracking-wide">Access Granted</p>
            </div>
        </div>

        <!-- Controls -->
        <div class="pointer-events-auto space-y-3 mt-auto" id="controls-area">
            <!-- Mode Toggle -->
            <div id="mode-toggle" class="glass p-1 rounded-2xl flex hidden">
                <button onclick="setMode('check-in')" id="btn-in" class="flex-1 py-3 rounded-xl text-sm font-bold shadow-lg transition-all bg-indigo-600 text-white relative overflow-hidden">
                    Check In
                </button>
                <button onclick="setMode('check-out')" id="btn-out" class="flex-1 py-3 rounded-xl text-sm font-bold text-gray-400 transition-all hover:text-white">
                    Check Out
                </button>
            </div>

            <!-- Start Button -->
            <button id="start-btn" onclick="startScanner()" class="w-full bg-white hover:bg-gray-100 text-black font-black text-lg py-4 rounded-2xl shadow-xl active:scale-95 transition disabled:opacity-50">
                Initialize Camera
            </button>
        </div>
    </div>

    <script>
        let html5QrCode;
        let config = null;
        let mode = 'check-in';
        let isProcessing = false;
        let scanTimeout;

        window.onload = () => {
            if (typeof Html5QrCode === 'undefined') {
                // Shim fallback
                if (window.__Html5QrcodeLibrary__) window.Html5QrCode = window.__Html5QrcodeLibrary__.Html5Qrcode;
            }
            
            if (typeof Html5QrCode !== 'undefined') {
                document.getElementById('start-btn').innerText = "Start Camera";
                loadConfig();
            } else {
                document.getElementById('start-btn').innerText = "Lib Error - Reload";
                document.getElementById('start-btn').onclick = () => location.reload();
            }
        };

        function loadConfig() {
            try {
                const saved = localStorage.getItem('ticketScannerConfig');
                if (saved) {
                    config = JSON.parse(saved);
                    updateUI(true);
                    // Warmup
                    fetch(`${config.apiBaseUrl}/api/scanner/warmup/${config.eventId}`, {
                        headers: { 'Authorization': `Bearer ${config.token}` },
                        keepalive: true
                    }).catch(()=>{});
                }
            } catch(e) { localStorage.removeItem('ticketScannerConfig'); }
        }

        async function startScanner() {
            const btn = document.getElementById('start-btn');
            btn.innerText = "Starting...";
            btn.disabled = true;

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                stream.getTracks().forEach(t => t.stop());

                html5QrCode = new Html5QrCode("reader");
                
                // ALIGNMENT FIX: Match JS logical box to CSS visual box
                // CSS is 70vw/70vh. We use the exact same ratio here.
                await html5QrCode.start(
                    { facingMode: "environment" },
                    { 
                        fps: 25, 
                        qrbox: (w, h) => {
                            const side = Math.min(w, h) * 0.70; // Exact match to CSS '70vw/vh'
                            return { width: side, height: side };
                        }
                    },
                    onScan,
                    () => {}
                );

                btn.classList.add('hidden');
                document.getElementById('scan-box').style.opacity = "1"; // Ensure visible

            } catch (err) {
                console.error(err);
                alert("Camera Error: " + err.message);
                btn.disabled = false;
                btn.innerText = "Retry";
            }
        }

        async function onScan(text) {
            if (isProcessing) return;
            isProcessing = true;

            // Freeze
            try { html5QrCode.pause(true); } catch(e){}
            if(navigator.vibrate) navigator.vibrate(50);
            
            // Visuals
            const box = document.getElementById('scan-box');
            box.classList.add('active');

            if (!config) {
                await handleSetup(text);
            } else {
                await handleTicket(text);
            }
        }

        async function handleSetup(text) {
            try {
                const data = JSON.parse(text);
                if (!data.eventId) throw new Error();
                config = data;
                localStorage.setItem('ticketScannerConfig', JSON.stringify(config));
                updateUI(true);
                showResult('success', 'Connected', config.eventId);
            } catch (e) {
                showResult('error', 'Setup Failed', 'Invalid QR');
            } finally {
                resetState(1500);
            }
        }

        async function handleTicket(id) {
            // Show loading state
            showResult('loading', 'Verifying...', id);

            try {
                const controller = new AbortController();
                const to = setTimeout(() => controller.abort(), 5000);

                const res = await fetch(`${config.apiBaseUrl}/api/scanner/update-ticket-status/${config.eventId}/${id}`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json', 
                        'Authorization': `Bearer ${config.token}` 
                    },
                    body: JSON.stringify({ action: mode }),
                    signal: controller.signal,
                    keepalive: true
                });
                clearTimeout(to);
                
                const data = await res.json();
                
                if (!res.ok) throw new Error(data.message || "Scan Failed");

                // Success - Show Name Huge
                const name = data.data?.attendeeName || data.attendeeName || "Unknown";
                showResult('success', name, data.message);

            } catch (e) {
                let isWarn = e.message.includes('Checked In');
                showResult(isWarn ? 'warning' : 'error', isWarn ? 'Already In' : 'Error', e.message);
            } finally {
                resetState(isProcessing ? 1000 : 0); // Faster reset
            }
        }

        function showResult(type, mainText, subText) {
            const card = document.getElementById('result-card');
            const icon = document.getElementById('result-icon');
            const name = document.getElementById('result-name');
            const msg = document.getElementById('result-msg');
            const area = document.getElementById('result-area');
            const box = document.getElementById('scan-box');

            area.classList.remove('hidden');
            
            // Colors
            const map = {
                success: { border: 'border-green-500', bg: 'bg-green-900/90', icon: '✅' },
                error:   { border: 'border-red-500',   bg: 'bg-red-900/90',   icon: '⛔' },
                warning: { border: 'border-yellow-500',bg: 'bg-yellow-900/90',icon: '⚠️' },
                loading: { border: 'border-blue-500',  bg: 'bg-gray-900/90',  icon: '⏳' }
            };
            
            const s = map[type] || map.loading;
            card.className = `glass rounded-3xl p-6 text-center shadow-2xl border-l-8 result-popup ${s.border} ${s.bg}`;
            icon.innerText = s.icon;
            name.innerText = mainText;
            msg.innerText = subText;

            // Box color
            if (type === 'error') box.classList.add('error');
            if (type === 'loading') box.style.borderColor = '#3b82f6';
        }

        function resetState(delay) {
            setTimeout(() => {
                isProcessing = false;
                document.getElementById('result-area').classList.add('hidden');
                const box = document.getElementById('scan-box');
                box.classList.remove('active', 'error');
                box.style.borderColor = 'rgba(255,255,255,0.5)';
                try { html5QrCode.resume(); } catch(e){}
            }, delay);
        }

        function updateUI(isConfigured) {
            if (isConfigured) {
                document.getElementById('event-name').innerText = config.eventId;
                document.getElementById('status-dot').className = "w-2.5 h-2.5 rounded-full bg-green-500 animate-pulse";
                document.getElementById('mode-toggle').classList.remove('hidden');
            } else {
                document.getElementById('event-name').innerText = "Setup Required";
                document.getElementById('mode-toggle').classList.add('hidden');
            }
        }

        function setMode(m) {
            mode = m;
            const active = "bg-indigo-600 text-white shadow-lg";
            const inactive = "text-gray-400 hover:text-white";
            document.getElementById('btn-in').className = `flex-1 py-3 rounded-xl text-sm font-bold transition-all ${mode==='check-in'?active:inactive}`;
            document.getElementById('btn-out').className = `flex-1 py-3 rounded-xl text-sm font-bold transition-all ${mode==='check-out'?"bg-pink-600 text-white shadow-lg":inactive}`;
        }

        function resetApp() {
            if (confirm("Reset Config?")) {
                localStorage.removeItem('ticketScannerConfig');
                location.reload();
            }
        }
    </script>
</body>
</html>