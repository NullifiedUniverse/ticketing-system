<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ticket Scanner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Library Loader with Redundancy -->
    <script>
        function loadScript(src, fallbackSrc) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = () => resolve('loaded');
                script.onerror = () => {
                    console.warn(`Failed to load ${src}, trying fallback...`);
                    if (fallbackSrc) {
                        const fallback = document.createElement('script');
                        fallback.src = fallbackSrc;
                        fallback.onload = () => resolve('fallback loaded');
                        fallback.onerror = (e) => reject(new Error(`Both primary and fallback scripts failed. Last error: ${e.type}`));
                        document.head.appendChild(fallback);
                    } else {
                        reject(new Error(`Failed to load ${src}`));
                    }
                };
                document.head.appendChild(script);
            });
        }
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Reset & Base */
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            background-color: #000; color: white; 
            font-family: 'Inter', sans-serif; overflow: hidden; 
        }

        /* Camera Layer */
        #reader { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 0; background: #000; 
        }
        #reader video { 
            object-fit: cover !important; width: 100% !important; height: 100% !important; 
        }

        /* UI Overlay Layer */
        .ui-layer {
            position: fixed; inset: 0; z-index: 10;
            display: flex; flex-direction: column; justify-content: space-between;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
            pointer-events: none;
        }

        .interactive { pointer-events: auto; }

        /* Scan Frame */
        .scan-frame {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 80%; max-width: 400px; aspect-ratio: 1;
            border-radius: 24px;
            box-shadow: 0 0 0 4000px rgba(0, 0, 0, 0.6);
        }
        
        .scan-corner {
            position: absolute; width: 60px; height: 60px;
            border-color: #6366f1; border-style: solid;
            transition: all 0.3s ease;
        }
        
        .tl { top: 0; left: 0; border-width: 6px 0 0 6px; border-radius: 24px 0 0 0; }
        .tr { top: 0; right: 0; border-width: 6px 6px 0 0; border-radius: 0 24px 0 0; }
        .bl { bottom: 0; left: 0; border-width: 0 0 6px 6px; border-radius: 0 0 0 24px; }
        .br { bottom: 0; right: 0; border-width: 0 6px 6px 0; border-radius: 0 0 24px 0; }

        .scanning .scan-corner { border-color: #22c55e; }
        .error .scan-corner { border-color: #ef4444; }
        .warning .scan-corner { border-color: #eab308; }

        /* Animations */
        @keyframes pulse-line {
            0% { top: 5%; opacity: 0; }
            50% { opacity: 1; }
            100% { top: 95%; opacity: 0; }
        }
        .scan-laser {
            position: absolute; left: 5%; right: 5%; height: 4px;
            background: #6366f1; box-shadow: 0 0 15px #6366f1;
            border-radius: 50%;
            animation: pulse-line 2s cubic-bezier(0.4, 0, 0.2, 1) infinite;
        }

        /* Floating Controls */
        .glass-panel {
            background: rgba(20, 20, 20, 0.8);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Debug Panel */
        #debug-panel {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(0,0,0,0.9);
            color: #0f0; font-family: monospace; font-size: 10px;
            padding: 10px; height: 150px; overflow-y: auto;
            z-index: 100; display: none;
        }
    </style>
</head>
<body>

    <div id="reader"></div>

    <div class="ui-layer">
        <!-- Top Bar -->
        <div class="w-full p-4 flex justify-between items-start interactive z-20">
            <div class="glass-panel rounded-xl p-3 flex items-center gap-3">
                <div class="w-2 h-2 rounded-full bg-red-500 animate-pulse" id="status-dot"></div>
                <div class="flex flex-col">
                    <span class="text-[10px] text-gray-400 uppercase tracking-wider font-bold">Current Event</span>
                    <span id="event-name" class="text-sm font-bold text-white leading-tight">Not Configured</span>
                </div>
            </div>
            
            <div class="flex gap-2">
                <button onclick="toggleDebug()" class="glass-panel p-3 rounded-full text-white/70 hover:text-white">
                    üêû
                </button>
                <button onclick="resetConfig()" class="glass-panel p-3 rounded-full text-white/70 hover:text-white active:scale-95 transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                </button>
            </div>
        </div>

        <!-- Scan Area (Visual Only) -->
        <div class="scan-frame hidden" id="scan-ui">
            <div class="scan-corner tl"></div>
            <div class="scan-corner tr"></div>
            <div class="scan-corner bl"></div>
            <div class="scan-corner br"></div>
            <div class="scan-laser"></div>
            <div class="absolute -bottom-12 left-0 right-0 text-center">
                <span class="glass-panel px-4 py-2 rounded-full text-xs font-medium text-white/90" id="scan-msg">Align QR Code within frame</span>
            </div>
        </div>

        <!-- Bottom Controls -->
        <div class="p-6 w-full space-y-4 interactive z-20">
            
            <!-- Toggle -->
            <div id="mode-toggle" class="hidden glass-panel p-1 rounded-xl flex w-full max-w-xs mx-auto">
                <button onclick="setMode('check-in')" id="btn-in" class="flex-1 py-3 rounded-lg text-sm font-bold transition-all bg-indigo-600 shadow-lg">Check In</button>
                <button onclick="setMode('check-out')" id="btn-out" class="flex-1 py-3 rounded-lg text-sm font-bold text-gray-400 hover:text-white transition-all">Check Out</button>
            </div>

            <!-- Primary Action -->
            <button id="action-btn" onclick="initCamera()" class="w-full bg-white text-black font-bold text-lg py-4 rounded-2xl shadow-xl active:scale-95 transition-transform" disabled>
                Loading Library...
            </button>
            
            <div id="status-text" class="text-center text-xs text-gray-500 h-4"></div>
        </div>
    </div>

    <!-- Notification System -->
    <div id="notification" class="fixed top-24 left-4 right-4 z-50 transform -translate-y-40 transition-transform duration-300 flex justify-center pointer-events-none">
        <div class="glass-panel px-6 py-4 rounded-2xl shadow-2xl border-l-4 flex items-center gap-4 max-w-sm mx-auto" id="notif-body">
            <span class="text-2xl" id="notif-icon"></span>
            <div>
                <h3 class="font-bold text-sm text-white" id="notif-title"></h3>
                <p class="text-xs text-gray-300" id="notif-msg"></p>
            </div>
        </div>
    </div>
    
    <!-- Debug Log Panel -->
    <div id="debug-panel"></div>

    <script>
        // --- LOGGER ---
        function debugLog(msg) {
            const panel = document.getElementById('debug-panel');
            const time = new Date().toLocaleTimeString();
            panel.innerHTML += `[${time}] ${msg}<br>`;
            panel.scrollTop = panel.scrollHeight;
            console.log(`[Scanner] ${msg}`);
        }
        
        function toggleDebug() {
            const panel = document.getElementById('debug-panel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        // --- LIBRARY LOADER ---
        (async function initLibrary() {
            debugLog("Initializing...");
            try {
                // Try Local First, then CDN
                await loadScript('/html5-qrcode.min.js', 'https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js');
                debugLog("Script Loaded. Checking globals...");
                
                // Manual Patch: If the library loaded but didn't expose the global, extract it.
                if (typeof Html5QrCode === 'undefined') {
                    debugLog("Global 'Html5QrCode' not found. Checking shim...");
                    if (typeof __Html5QrcodeLibrary__ !== 'undefined') {
                        window.Html5QrCode = __Html5QrcodeLibrary__.Html5Qrcode;
                        window.Html5QrcodeScanner = __Html5QrcodeLibrary__.Html5QrcodeScanner;
                        debugLog("Manually assigned globals from shim.");
                    } else if (window.__Html5QrcodeLibrary__) {
                        window.Html5QrCode = window.__Html5QrcodeLibrary__.Html5Qrcode;
                        window.Html5QrcodeScanner = window.__Html5QrcodeLibrary__.Html5QrcodeScanner;
                        debugLog("Manually assigned globals from window shim.");
                    }
                }

                // Check if class exists now
                if (typeof Html5QrCode === 'undefined') {
                    throw new Error("Html5QrCode class is undefined after load.");
                }
                
                debugLog("Library Ready.");
                document.getElementById('action-btn').disabled = false;
                loadConfig();
            } catch (e) {
                debugLog(`CRITICAL ERROR: ${e.message}`);
                showNotif('error', 'Load Error', 'Scanner library failed. Check Debug Log.');
                document.getElementById('action-btn').innerText = "Library Load Failed";
            }
        })();

        // --- GLOBALS ---
        let html5QrCode;
        let config = null;
        let currentMode = 'check-in';
        let isScanning = false;
        let isProcessing = false; // Lock for API calls

        // --- ELEMENTS ---
        const els = {
            eventName: document.getElementById('event-name'),
            statusDot: document.getElementById('status-dot'),
            scanUi: document.getElementById('scan-ui'),
            scanMsg: document.getElementById('scan-msg'),
            modeToggle: document.getElementById('mode-toggle'),
            btnIn: document.getElementById('btn-in'),
            btnOut: document.getElementById('btn-out'),
            actionBtn: document.getElementById('action-btn'),
            statusText: document.getElementById('status-text'),
            notif: document.getElementById('notification'),
            notifBody: document.getElementById('notif-body'),
            notifIcon: document.getElementById('notif-icon'),
            notifTitle: document.getElementById('notif-title'),
            notifMsg: document.getElementById('notif-msg'),
        };

        function loadConfig() {
            const saved = localStorage.getItem('ticketScannerConfig');
            if (saved) {
                try {
                    config = JSON.parse(saved);
                    els.eventName.innerText = config.eventId;
                    els.statusDot.classList.replace('bg-red-500', 'bg-yellow-500');
                    els.modeToggle.classList.remove('hidden');
                    els.actionBtn.innerText = "Start Scanning";
                    els.scanMsg.innerText = "Scan Attendee Ticket";
                    debugLog("Config loaded for event: " + config.eventId);
                } catch (e) {
                    debugLog("Config parse error. Clearing.");
                    localStorage.removeItem('ticketScannerConfig');
                }
            } else {
                els.eventName.innerText = "Setup Required";
                els.scanMsg.innerText = "Scan Setup QR Code";
                els.actionBtn.innerText = "Start Setup";
                debugLog("No config found. Setup mode.");
            }
        }

        // --- CAMERA PIPELINE ---
        async function initCamera() {
            els.actionBtn.disabled = true;
            els.actionBtn.innerText = "Requesting Access...";
            debugLog("Starting Camera Pipeline...");
            
            try {
                // Step 1: Force Permission via Native API
                debugLog("Requesting getUserMedia...");
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment" } 
                });
                
                // Step 2: Clean up stream immediately
                debugLog("Permission Granted. Stopping temp stream.");
                stream.getTracks().forEach(track => track.stop());

                // Step 3: Brief cooldown for OS
                await new Promise(r => setTimeout(r, 300));

                // Step 4: Start Library
                debugLog("Instantiating Html5QrCode...");
                html5QrCode = new Html5QrCode("reader");
                
                const ratio = window.innerWidth / window.innerHeight;
                debugLog(`Starting scanner with ratio ${ratio.toFixed(2)}`);

                await html5QrCode.start(
                    { facingMode: "environment" },
                    { 
                        fps: 20, // Faster scanning
                        qrbox: (viewfinderWidth, viewfinderHeight) => {
                            return { width: 250, height: 250 };
                        },
                        aspectRatio: ratio
                    },
                    onScan,
                    onScanError
                );

                // Step 5: UI Success State
                debugLog("Scanner Started!");
                isScanning = true;
                els.scanUi.classList.remove('hidden');
                els.actionBtn.classList.add('hidden');
                els.statusDot.className = "w-2 h-2 rounded-full bg-green-500 animate-pulse";
                els.statusText.innerText = "";

            } catch (err) {
                console.error(err);
                debugLog(`CAMERA FAIL: ${err.name} - ${err.message}`);
                els.actionBtn.disabled = false;
                els.actionBtn.innerText = "Retry Camera";
                handleCameraError(err);
            }
        }

        async function onScan(text, result) {
            if (isProcessing) return;
            isProcessing = true;
            debugLog(`Scanned: ${text}`);
            
            // Visual Feedback
            document.querySelector('.scan-frame').classList.add('scanning');
            if(navigator.vibrate) navigator.vibrate(50);

            if (!config) {
                await processSetup(text);
            } else {
                await processTicket(text);
            }
        }

        function onScanError(err) {
            // Too noisy to log every frame error
        }

        // --- BUSINESS LOGIC ---

        async function processSetup(text) {
            try {
                const data = JSON.parse(text);
                if (!data.eventId || !data.token) throw new Error("Invalid QR Data");

                config = data;
                localStorage.setItem('ticketScannerConfig', JSON.stringify(config));
                
                showNotif('success', 'Setup Complete', `Connected to ${config.eventId}`);
                debugLog("Setup Success");
                
                // Update UI
                els.eventName.innerText = config.eventId;
                els.modeToggle.classList.remove('hidden');
                els.scanMsg.innerText = "Scan Attendee Ticket";
                els.statusDot.className = "w-2 h-2 rounded-full bg-green-500 animate-pulse";

                // --- PERFORMANCE OPTIMIZATION ---
                // Trigger backend cache warmup immediately so the first ticket scan is fast
                debugLog("Triggering cache warmup...");
                fetch(`${config.apiBaseUrl}/api/scanner/warmup/${config.eventId}`, {
                    headers: { 'Authorization': `Bearer ${config.token}` }
                }).then(() => debugLog("Cache Warmup: Sent"))
                  .catch(e => debugLog("Cache Warmup: Failed (Non-critical)"));

            } catch (e) {
                debugLog(`Setup Error: ${e.message}`);
                showNotif('error', 'Setup Failed', 'Invalid setup QR code.');
                document.querySelector('.scan-frame').classList.add('error');
            } finally {
                setTimeout(() => {
                    isProcessing = false;
                    document.querySelector('.scan-frame').classList.remove('scanning', 'error');
                }, 1000);
            }
        }

        async function processTicket(ticketId) {
            showNotif('loading', 'Verifying...', 'Checking with server...');
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 5000); // 5s timeout

            try {
                const res = await fetch(`${config.apiBaseUrl}/api/scanner/update-ticket-status/${config.eventId}/${ticketId}`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json', 
                        'Authorization': `Bearer ${config.token}` 
                    },
                    body: JSON.stringify({ action: currentMode }),
                    signal: controller.signal,
                    keepalive: true
                });
                clearTimeout(timeoutId);

                const data = await res.json();

                if (!res.ok) {
                    // Handle Business Logic Errors (400) differently from System Errors (500)
                    if (res.status === 400) {
                        throw new Error(`WARN:${data.message}`);
                    }
                    throw new Error(data.message || 'Scan failed');
                }

                // API returns { status: 'success', message: 'Checked In: ...', data: { ... } }
                const successMsg = data.message || data.data?.message || 'Access Granted';
                showNotif('success', 'Valid Ticket', successMsg);
                debugLog(`Ticket OK: ${ticketId}`);
                
            } catch (err) {
                clearTimeout(timeoutId);
                
                let isWarning = false;
                let msg = err.message;

                if (msg.startsWith('WARN:')) {
                    isWarning = true;
                    msg = msg.replace('WARN:', '');
                } else if (err.name === 'AbortError') {
                    msg = "Network timeout. Try again.";
                }

                if (isWarning) {
                    showNotif('warning', 'Check Status', msg);
                    document.querySelector('.scan-frame').classList.add('warning');
                } else {
                    showNotif('error', 'Access Denied', msg);
                    document.querySelector('.scan-frame').classList.add('error');
                    if(navigator.vibrate) navigator.vibrate([100, 50, 100]);
                }
                
                debugLog(`Ticket Fail: ${msg}`);
            } finally {
                 // Reset Visuals Quicker (500ms for snappier feel)
                setTimeout(() => {
                    isProcessing = false;
                    document.querySelector('.scan-frame').classList.remove('scanning', 'error', 'warning');
                }, 500);
            }
        }

        // --- HELPERS ---

        function setMode(mode) {
            currentMode = mode;
            debugLog(`Mode: ${mode}`);
            if (mode === 'check-in') {
                els.btnIn.className = "flex-1 py-3 rounded-lg text-sm font-bold transition-all bg-indigo-600 shadow-lg text-white";
                els.btnOut.className = "flex-1 py-3 rounded-lg text-sm font-bold text-gray-400 hover:text-white transition-all";
            } else {
                els.btnIn.className = "flex-1 py-3 rounded-lg text-sm font-bold text-gray-400 hover:text-white transition-all";
                els.btnOut.className = "flex-1 py-3 rounded-lg text-sm font-bold transition-all bg-pink-600 shadow-lg text-white";
            }
        }

        function resetConfig() {
            if(confirm("Reset scanner configuration?")) {
                localStorage.removeItem('ticketScannerConfig');
                location.reload();
            }
        }

        function handleCameraError(err) {
            let msg = "Camera failed to start.";
            if (err.name === 'NotAllowedError') msg = "Permission denied. Reset browser permissions.";
            if (err.name === 'NotFoundError') msg = "No camera found.";
            if (err.name === 'NotReadableError') msg = "Camera in use by another app.";
            showNotif('error', 'Camera Error', msg);
            els.statusText.innerText = msg;
        }

        let notifTimeout;
        function showNotif(type, title, msg) {
            // 1. Cancel any pending dismissal
            if (notifTimeout) {
                clearTimeout(notifTimeout);
                notifTimeout = null;
            }
            
            // 2. Show the notification immediately
            els.notif.style.transform = 'translateY(0)';
            els.notifTitle.innerText = title;
            els.notifTitle.style.fontSize = '1.1rem';
            
            els.notifMsg.innerText = msg;
            els.notifMsg.style.fontSize = '1rem';

            const colors = {
                success: 'border-green-500 bg-green-900/90',
                error: 'border-red-500 bg-red-900/90',
                loading: 'border-blue-500 bg-blue-900/90',
                warning: 'border-yellow-500 bg-yellow-900/90'
            };
            
            const icons = {
                success: '‚úÖ', error: '‚õî', loading: '‚è≥', warning: '‚ö†Ô∏è'
            };

            // 3. Apply styles (larger padding, better background)
            els.notifBody.className = `backdrop-blur-xl px-8 py-6 rounded-3xl shadow-2xl border-l-8 flex items-center gap-6 max-w-md mx-auto w-full ${colors[type] || 'border-white bg-gray-900/90'}`;
            els.notifIcon.innerText = icons[type] || '‚ÑπÔ∏è';
            els.notifIcon.style.fontSize = '2.5rem';

            // 4. Auto-dismiss after 1.5 seconds (unless loading)
            if (type !== 'loading') {
                notifTimeout = setTimeout(() => {
                    els.notif.style.transform = 'translateY(-15rem)';
                }, 1500);
            }
        }

    </script>
</body>
</html>