<!DOCTYPE html>
<html lang="en">
<head>
    <!-- System Generation by NullifiedGalaxy -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- Security: Content Security Policy -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://unpkg.com;
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
        font-src 'self' https://fonts.gstatic.com;
        img-src 'self' data: blob:;
        media-src 'self' data:;
        connect-src *;
        object-src 'none';
        base-uri 'self';
    ">

    <title>Ticket Scanner</title>
    
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/html5-qrcode.min.js" id="lib-qr"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        /* Optimized Dark Theme - Deep Cosmos Match */
        :root {
            --color-primary: #6366f1; /* Indigo 500 */
            --color-success: #22c55e; /* Green 500 */
            --color-error: #ef4444; /* Red 500 */
            --color-warning: #eab308; /* Yellow 500 */
            --glass-bg: rgba(20, 20, 20, 0.6);
            --glass-border: rgba(255,255,255,0.1);
        }

        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: #020617; /* Slate 950 */
            background-image: 
                radial-gradient(at 0% 0%, rgba(239, 68, 68, 0.15) 0px, transparent 50%),      /* Red */
                radial-gradient(at 50% 0%, rgba(234, 179, 8, 0.15) 0px, transparent 50%),     /* Yellow */
                radial-gradient(at 100% 0%, rgba(34, 197, 94, 0.15) 0px, transparent 50%),    /* Green */
                radial-gradient(at 100% 100%, rgba(59, 130, 246, 0.15) 0px, transparent 50%), /* Blue */
                radial-gradient(at 0% 100%, rgba(168, 85, 247, 0.15) 0px, transparent 50%);   /* Purple */
            background-attachment: fixed;
            overflow: hidden; 
            color: #e2e8f0;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Fullscreen Camera Container */
        #reader { 
            position: fixed; 
            top: 0; left: 0; right: 0; bottom: 0;
            width: 100% !important; 
            height: 100% !important; 
            z-index: 0; 
            background: black; 
            border: none !important;
        }
        
        /* Force Video to Cover Screen */
        #reader video { 
            width: 100% !important; 
            height: 100% !important; 
            object-fit: cover !important; 
            border-radius: 0 !important;
        }

        /* Hide Library's Default Overlays/Canvas */
        #reader canvas, #reader__scan_region { 
            display: none !important; 
        }

        /* 
           Custom Overlay - Centered & Responsive
        */
        .scanner-overlay {
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%);
            
            /* Responsive Size: 65% of the smaller dimension */
            width: 65vmin; 
            height: 65vmin;
            
            /* Limits */
            max-width: 500px; 
            max-height: 500px;
            
            z-index: 10;
            pointer-events: none;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Visual Feedback via Box Shadow Flash instead of Border */
        .scanner-overlay.active { 
            box-shadow: 0 0 0 0 rgba(0,0,0,0), 0 0 50px 20px rgba(34, 197, 94, 0.6) inset; 
            transform: translate(-50%, -50%) scale(1.05); 
        }
        
        .scanner-overlay.error { 
            box-shadow: 0 0 0 0 rgba(0,0,0,0), 0 0 50px 20px rgba(239, 68, 68, 0.6) inset; 
        }

        /* Laser Animation - Smoother */
        .laser {
            position: absolute; 
            width: 100%; 
            height: 2px; 
            background: var(--color-primary);
            box-shadow: 0 0 15px var(--color-primary); 
            top: 50%;
            opacity: 0.6;
            animation: scan 2.5s infinite ease-in-out;
        }
        
        @keyframes scan { 
            0% { transform: translateY(-35vmin) scaleX(0.9); opacity: 0; } 
            10% { opacity: 1; }
            50% { transform: translateY(0) scaleX(1); opacity: 0.5; } 
            90% { opacity: 1; }
            100% { transform: translateY(35vmin) scaleX(0.9); opacity: 0; } 
        }

        /* Modern Glass UI */
        .glass {
            background: rgba(2, 6, 23, 0.6); /* Slate 950 / 60% */
            backdrop-filter: blur(32px);
            -webkit-backdrop-filter: blur(32px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        /* Popups - Enhanced Pop Animation */
        .popup-enter {
            animation: popIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }
        @keyframes popIn { 
            0% { transform: translateY(-50px) scale(0.9); opacity: 0; filter: blur(10px); } 
            100% { transform: translateY(0) scale(1); opacity: 1; filter: blur(0px); } 
        }

        /* Gradient Border Utility */
        .gradient-border-mask {
            position: relative;
            background: rgba(20, 20, 20, 0.85);
            background-clip: padding-box;
            border: 2px solid transparent;
            border-radius: 2rem;
        }
        .gradient-border-mask::before {
            content: "";
            position: absolute;
            inset: 0;
            z-index: -1;
            margin: -2px;
            border-radius: inherit;
            background: linear-gradient(to right, var(--color-primary), var(--color-success));
        }
    </style>
</head>
<body>
    <!-- Security: Anti-Tamper -->
    <script>
        // ... (unchanged)
        // Disable Context Menu
        document.addEventListener('contextmenu', event => event.preventDefault());

        // Disable DevTools Shortcuts
        document.addEventListener('keydown', event => {
            if (
                event.key === 'F12' || 
                (event.ctrlKey && event.shiftKey && (event.key === 'I' || event.key === 'J' || event.key === 'C')) || 
                (event.ctrlKey && event.key === 'u')
            ) {
                event.preventDefault();
                return false;
            }
        });

        // Clear Console
        console.clear();
    </script>

    <!-- Camera Container -->
    <div id="reader"></div>

    <!-- Visual Overlay -->
    <div class="scanner-overlay" id="scan-box">
        <div class="laser"></div>
        <!-- Stylish Corners -->
        <div class="absolute top-0 left-0 w-10 h-10 border-t-[5px] border-l-[5px] border-white rounded-tl-2xl -mt-1 -ml-1"></div>
        <div class="absolute top-0 right-0 w-10 h-10 border-t-[5px] border-r-[5px] border-white rounded-tr-2xl -mt-1 -mr-1"></div>
        <div class="absolute bottom-0 left-0 w-10 h-10 border-b-[5px] border-l-[5px] border-white rounded-bl-2xl -mb-1 -ml-1"></div>
        <div class="absolute bottom-0 right-0 w-10 h-10 border-b-[5px] border-r-[5px] border-white rounded-br-2xl -mb-1 -mr-1"></div>
    </div>

    <!-- UI Overlay Layer (Click-through except buttons) -->
    <div class="fixed inset-0 z-20 flex flex-col p-safe-area pointer-events-none">
        
        <!-- Top Navigation Bar -->
        <div class="flex justify-between items-start p-4 pointer-events-auto relative z-10">
            
            <!-- Status Badge -->
            <div class="glass px-4 py-2.5 rounded-full flex items-center gap-3 shadow-lg transition-all" id="status-badge">
                <div id="status-dot" class="w-2.5 h-2.5 rounded-full bg-gray-500 transition-colors duration-300"></div>
                <div class="flex flex-col leading-none">
                    <span class="text-[9px] text-gray-400 font-bold uppercase tracking-wider mb-0.5">Event</span>
                    <span id="event-name" class="text-xs font-bold text-white truncate max-w-[120px]">Not Linked</span>
                </div>
            </div>

            <!-- Settings Controls -->
            <div class="flex gap-2">
                <!-- ... buttons unchanged ... -->
                <!-- Torch Toggle -->
                <button onclick="toggleTorch()" id="btn-torch" class="glass w-10 h-10 rounded-full flex items-center justify-center text-white/70 hover:text-white hover:bg-white/10 active:scale-95 transition hidden">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                </button>

                <!-- Mute Toggle -->
                <button onclick="toggleMute()" id="btn-mute" class="glass w-10 h-10 rounded-full flex items-center justify-center text-white/70 hover:text-white hover:bg-white/10 active:scale-95 transition">
                    <svg id="icon-mute" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /></svg>
                </button>

                <!-- Reset -->
                <button onclick="resetApp()" class="glass w-10 h-10 rounded-full flex items-center justify-center text-white/70 hover:text-white hover:bg-white/10 active:scale-95 transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                </button>
            </div>
        </div>

        <!-- Result Card Area (Moved to TOP, Highest Z-Index) -->
        <div id="result-area" class="fixed top-24 left-0 right-0 px-6 hidden flex justify-center w-full z-[100] pointer-events-none">
            <div class="glass p-1 rounded-[2.5rem] shadow-2xl popup-enter pointer-events-auto" id="result-wrapper">
                <div class="bg-gray-900/90 backdrop-blur-3xl rounded-[2.3rem] p-6 w-full max-w-sm text-center relative overflow-hidden border border-white/10" id="result-card">
                    <!-- Dynamic Glow -->
                    <div id="result-glow" class="absolute inset-0 opacity-20 bg-gradient-to-tr from-green-500 to-emerald-500"></div>
                    
                    <div class="relative z-10">
                        <div id="result-icon" class="text-6xl mb-2 filter drop-shadow-lg transform transition-transform hover:scale-110">‚úÖ</div>
                        <h1 id="result-name" class="text-3xl font-black text-white leading-tight mb-1 break-words tracking-tight drop-shadow-md">Attendee</h1>
                        <p id="result-msg" class="text-xs font-bold text-white/80 uppercase tracking-[0.2em] bg-white/10 py-1 px-3 rounded-full inline-block backdrop-blur-md">Access Granted</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Controls Area (Fixed Bottom) -->
        <div class="fixed bottom-0 left-0 right-0 z-40 p-4 pb-8 glass border-t border-white/10 rounded-t-[2rem] backdrop-blur-xl transition-transform duration-300 pointer-events-auto" id="controls-area">
            
            <!-- Toggle Switch (Check-In / Check-Out) -->
            <div id="mode-toggle" class="glass p-1.5 rounded-2xl flex hidden mb-3 bg-black/40">
                <button onclick="setMode('check-in')" id="btn-in" class="flex-1 py-3 rounded-xl text-sm font-extrabold shadow-lg transition-all relative overflow-hidden">
                    Check In
                </button>
                <button onclick="setMode('check-out')" id="btn-out" class="flex-1 py-3 rounded-xl text-sm font-extrabold transition-all relative overflow-hidden">
                    Check Out
                </button>
            </div>

            <!-- Initialization Button -->
            <button id="start-btn" onclick="startScanner()" class="w-full bg-white hover:bg-gray-100 active:bg-gray-200 text-black font-black text-lg py-4 rounded-2xl shadow-xl active:scale-95 transition-all disabled:opacity-50 disabled:scale-100 mb-3">
                Initialize Camera
            </button>
            
            <!-- Report Issue Button -->
            <button onclick="reportIssue()" class="w-full bg-red-500/20 hover:bg-red-500/30 text-red-400 font-bold py-3 rounded-xl border border-red-500/30 active:scale-95 transition-all text-sm flex items-center justify-center gap-2">
                <span>‚ö†Ô∏è Report Issue to Dashboard</span>
            </button>
            
            <div class="text-center mt-2 text-[10px] text-white/20 font-mono pointer-events-none">
                NullifiedGalaxy
            </div>
        </div>
    </div>

    <script>
        let html5QrCode;
        let config = null;
        let mode = 'check-in';
        let isProcessing = false;
        let isCameraRunning = false;
        let shouldCameraRun = false; // Tracks user intent
        let isTorchOn = false;
        let isMuted = false;

        // --- Sound Manager (Low Latency) ---
        class SoundManager {
            constructor() {
                this.sounds = {
                    success: new Audio("data:audio/mp3;base64,//uQRAAAAWMSLwUIYAAsYkXgoQwAEaYLWfkWgAI0wWs/ItAAAGDgYtAgAyN+QWaAAihwMWm4G8QQRDiMcCBcH3Cc+CDv/7cxxHNTuIHQTyOdnQRx+TAlLFKD4gPp4CompHDyg958lLv/7ceRB3d8dz/DgDAOIDqagaER8L4tuHgqsg8aCPvprmgAd//uQRAAAAWMSLwUIYAAsYkXgoQwAEaYLWfkWgAI0wWs/ItAAAGDgYtAgAyN+QWaAAihwMWm4G8QQRDiMcCBcH3Cc+CDv/7cxxHNTuIHQTyOdnQRx+TAlLFKD4gPp4CompHDyg958lLv/7ceRB3d8dz/DgDAOIDqagaER8L4tuHgqsg8aCPvprmgAd"), // Placeholder Short Beep
                    error: new Audio("data:audio/mp3;base64,//uQRAAAAWMSLwUIYAAsYkXgoQwAEaYLWfkWgAI0wWs/ItAAAGDgYtAgAyN+QWaAAihwMWm4G8QQRDiMcCBcH3Cc+CDv/7cxxHNTuIHQTyOdnQRx+TAlLFKD4gPp4CompHDyg958lLv/7ceRB3d8dz/DgDAOIDqagaER8L4tuHgqsg8aCPvprmgAd"), // Placeholder Buzz
                    warning: new Audio("data:audio/mp3;base64,//uQRAAAAWMSLwUIYAAsYkXgoQwAEaYLWfkWgAI0wWs/ItAAAGDgYtAgAyN+QWaAAihwMWm4G8QQRDiMcCBcH3Cc+CDv/7cxxHNTuIHQTyOdnQRx+TAlLFKD4gPp4CompHDyg958lLv/7ceRB3d8dz/DgDAOIDqagaER8L4tuHgqsg8aCPvprmgAd") // Placeholder Double
                };
                // Preload
                Object.values(this.sounds).forEach(s => s.load());
            }

            play(type) {
                if (isMuted) return;
                const sound = this.sounds[type];
                if (sound) {
                    sound.currentTime = 0; // Reset to start for rapid fire
                    sound.play().catch(e => console.warn("Audio play failed", e));
                }
            }
            
            // Unlock audio context on mobile
            unlock() {
                const s = this.sounds.success;
                s.play().then(() => {
                    s.pause();
                    s.currentTime = 0;
                }).catch(() => {});
            }
        }
        
        const soundManager = new SoundManager();

        window.onload = async () => {
            // 1. Try Shim
            if (typeof Html5QrCode === 'undefined' && window.__Html5QrcodeLibrary__) {
                window.Html5QrCode = window.__Html5QrcodeLibrary__.Html5Qrcode;
            }
            
            // 2. Check & Fallback
            if (typeof Html5QrCode === 'undefined') {
                console.warn("Local library failed. Attempting CDN fallback...");
                try {
                    await loadScript('https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js');
                    if (typeof Html5QrCode === 'undefined' && window.__Html5QrcodeLibrary__) {
                        window.Html5QrCode = window.__Html5QrcodeLibrary__.Html5Qrcode;
                    }
                } catch (e) {
                    console.error("CDN Fallback failed", e);
                }
            }

            // 3. Final Init
            if (typeof Html5QrCode !== 'undefined') {
                document.getElementById('start-btn').innerText = "Tap to Start";
                loadConfig();
            } else {
                showErrorButton();
            }

            // Lifecycle Listeners
            document.addEventListener("visibilitychange", handleVisibilityChange);
            window.addEventListener("pagehide", stopCameraInternal);
        };

        function showErrorButton() {
            const btn = document.getElementById('start-btn');
            btn.innerText = "Library Error";
            btn.classList.remove('hidden');
            btn.classList.add('bg-red-500', 'text-white');
            btn.disabled = true;
            alert("Could not load QR Library. Check internet connection.");
        }

        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const s = document.createElement('script');
                s.src = src;
                s.onload = resolve;
                s.onerror = reject;
                document.head.appendChild(s);
            });
        }

        function loadConfig() {
            try {
                const saved = localStorage.getItem('ticketScannerConfig');
                if (saved) {
                    config = JSON.parse(saved);
                    updateUI(true);
                    // Silent Warmup
                    fetch(`${config.apiBaseUrl}/api/scanner/warmup/${config.eventId}`, {
                        headers: { 'Authorization': `Bearer ${config.token}` },
                        keepalive: true
                    }).catch(console.warn);
                }
            } catch(e) { 
                localStorage.removeItem('ticketScannerConfig'); 
            }
        }

        async function handleVisibilityChange() {
            if (document.hidden) {
                await stopCameraInternal();
            } else {
                // Small delay to ensure browser is ready
                setTimeout(() => {
                    if (shouldCameraRun && !isCameraRunning) {
                        startScanner();
                    }
                }, 300);
            }
        }

        async function stopCameraInternal() {
            if (html5QrCode && isCameraRunning) {
                try {
                    await html5QrCode.stop();
                    isCameraRunning = false;
                    // UI update: Show start button if we stopped? 
                    // No, if it's just backgrounding, we want to keep the "scanning" UI state mostly 
                    // or show a "Paused" state? 
                    // For simplicity, we just stop the feed. When resuming, we restart.
                    // If we stop, the video element goes blank.
                } catch (err) {
                    console.error("Failed to stop camera", err);
                }
            }
        }

        async function startScanner() {
            const btn = document.getElementById('start-btn');
            
            // User intent confirmed
            shouldCameraRun = true;
            
            // Unlock Audio Context on user gesture
            soundManager.unlock();

            if (isCameraRunning) return;

            btn.innerText = "Accessing Camera...";
            btn.disabled = true;

            try {
                // 1. Request Permissions (if not already granted)
                // Note: getUserMedia might fail if app is not focused, but we are calling this on click or resume (visible).
                
                // 2. Init Lib (Reuse if exists)
                if (!html5QrCode) {
                    html5QrCode = new Html5QrCode("reader");
                }
                
                // 3. Calculate optimal box size
                const getQrBoxSize = (viewfinderWidth, viewfinderHeight) => {
                    const minEdge = Math.min(viewfinderWidth, viewfinderHeight);
                    return { 
                        width: Math.floor(minEdge * 0.65), 
                        height: Math.floor(minEdge * 0.65) 
                    };
                };

                // 4. Start
                                await html5QrCode.start(
                                    {
                                        facingMode: "environment",
                                        width: { ideal: 1920 },
                                        height: { ideal: 1080 },
                                        advanced: [
                                            { brightness: { ideal: 1.0 } },
                                            { contrast: { ideal: 1.5 } },
                                            { whiteBalanceMode: { ideal: "continuous" } },
                                            { exposureMode: { ideal: "continuous" } }
                                        ]
                                    },
                                    {
                                        fps: 20, // Increased for faster scanning
                                        qrbox: getQrBoxSize,
                                        disableFlip: false,
                                        formatsToSupport: [ 0 ] // QR_CODE
                                    },
                                    onScan,
                                    (err) => { /* Ignore frame errors */ }
                                );
                isCameraRunning = true;
                btn.classList.add('hidden'); // Hide button
                document.getElementById('scan-box').style.opacity = "1"; 
                
                // Tap to Scan Next (Speed Mode)
                // Remove existing listener to avoid duplicates? 
                // document.body.removeEventListener... (Need named function for that)
                // Ideally we add this once in init, but we need isProcessing check.
                // Let's define the handler outside or check if added.
                // For simplicity in this script block, we can leave it or optimize.
                // Better: Define handler once.
                
            } catch (err) {
                console.error(err);
                // Only alert if user explicitly clicked (not on auto-resume)?
                // But auto-resume failure is also bad.
                // Let's show the button again.
                btn.disabled = false;
                btn.innerText = "Retry Camera";
                btn.classList.remove('hidden');
                btn.classList.add('bg-red-100', 'text-red-900');
                isCameraRunning = false;
                // If error occurs, maybe we shouldn't auto-retry endlessly?
                // Keep shouldCameraRun = true? No, maybe false to force user interaction.
                if (document.visibilityState === 'visible') {
                     alert("Camera Error: " + (err.message || "Permission Denied"));
                     shouldCameraRun = false; 
                }
            }
        }

        // Setup Global Click Listener once
        document.body.addEventListener('click', () => {
            if (isProcessing && document.getElementById('result-area').classList.contains('hidden') === false) {
                resetState(0);
            }
        });

        async function toggleTorch() {
            if (!html5QrCode || !isCameraRunning) return;
            
            try {
                await html5QrCode.applyVideoConstraints({
                    advanced: [{ torch: !isTorchOn }]
                });
                isTorchOn = !isTorchOn;
                
                const btn = document.getElementById('btn-torch');
                if (isTorchOn) {
                    btn.classList.add('bg-yellow-500', 'text-white', 'shadow-lg');
                    btn.classList.remove('text-white/70');
                } else {
                    btn.classList.remove('bg-yellow-500', 'text-white', 'shadow-lg');
                    btn.classList.add('text-white/70');
                }
            } catch (err) {
                console.error("Torch failed", err);
            }
        }

        function toggleMute() {
            isMuted = !isMuted;
            const btn = document.getElementById('btn-mute');
            const icon = document.getElementById('icon-mute');
            
            if (isMuted) {
                btn.classList.add('bg-red-500', 'text-white');
                btn.classList.remove('text-white/70');
                // Mute Icon
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2" />';
            } else {
                btn.classList.remove('bg-red-500', 'text-white');
                btn.classList.add('text-white/70');
                // Sound Icon
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />';
            }
        }

        async function onScan(text) {
            if (isProcessing) return;
            isProcessing = true;
            markStart('Total Scan Loop');

            // Immediate Feedback
            markStart('UI Feedback (Vibrate/DOM)');
            if (!isMuted && navigator.vibrate) navigator.vibrate(40);
            
            const box = document.getElementById('scan-box');
            box.classList.add('active'); // Visual flash

            // OPTIMISTIC UI: Show "Processing" immediately
            showResult('loading', 'Processing...', 'Verifying Ticket');
            markEnd('UI Feedback (Vibrate/DOM)');

            if (!config) {
                await handleSetup(text);
            } else {
                await handleTicket(text);
            }
            const totalDuration = markEnd('Total Scan Loop');

            // Collect and send performance metrics to backend
            if (config && config.eventId) {
                const perfMetrics = {
                    'Total Scan Loop': totalDuration,
                    'API Network Request': perfMetricsData['API Network Request'],
                    'Response Parse': perfMetricsData['Response Parse'],
                    'UI Feedback (Vibrate/DOM)': perfMetricsData['UI Feedback (Vibrate/DOM)']
                };
                logPerformanceMetrics(config.eventId, perfMetrics, config);
            }
        }
        
        // Store metrics temporarily
        const perfMetricsData = {};
        function markStart(label) {
            perfMetricsData[label] = performance.now();
        }
        function markEnd(label) {
            const start = perfMetricsData[label];
            if (start) {
                const duration = performance.now() - start;
                perfMetricsData[label] = duration; // Store duration
                console.log(`[Perf] ${label}: ${duration.toFixed(2)}ms`);
                return duration;
            }
            return 0;
        }

        function logPerformanceMetrics(eventId, metrics, scannerConfig) {
            if (!config || !config.apiBaseUrl || !config.token) return;

            fetch(`${config.apiBaseUrl}/api/scanner/log-perf`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${config.token}`,
                    'ngrok-skip-browser-warning': 'true'
                },
                body: JSON.stringify({
                    eventId: eventId,
                    metrics: metrics,
                    timestamp: Date.now(),
                    config: {
                        apiBaseUrl: scannerConfig.apiBaseUrl,
                        mode: mode,
                        fps: 15 // Assuming this is static
                    }
                }),
                keepalive: true // Send even if page is closing
            }).catch(e => console.error("Failed to log performance to backend:", e));
        }

        async function handleSetup(text) {
            try {
                const data = JSON.parse(text);
                if (!data.eventId || !data.apiBaseUrl) throw new Error("Missing Config");
                
                config = data;
                localStorage.setItem('ticketScannerConfig', JSON.stringify(config));
                
                updateUI(true);
                showResult('success', 'Linked!', config.eventId);
                
                // Force reload to apply new API Base URL logic if needed, 
                // but for SPA feel we just reset state
                
            } catch (e) {
                showResult('error', 'Invalid Setup QR', 'Scan the Dashboard QR');
            } finally {
                resetState(1500);
            }
        }

        // Network Retry Logic
        async function fetchWithRetry(url, options, retries = 3, backoff = 300) {
            try {
                return await fetch(url, options);
            } catch (err) {
                if (retries > 0) {
                    await new Promise(r => setTimeout(r, backoff));
                    return fetchWithRetry(url, options, retries - 1, backoff * 2);
                }
                throw err;
            }
        }

        async function handleTicket(id) {
            // Note: 'loading' state is already set in onScan for immediate feedback.

            try {
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 15000); // 15s Timeout for stability (increased for retry)

                markStart('API Network Request');
                
                // Use Retry Logic for Robustness
                const res = await fetchWithRetry(`${config.apiBaseUrl}/api/scanner/update-ticket-status/${config.eventId}/${id}`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json', 
                        'Authorization': `Bearer ${config.token}`,
                        'ngrok-skip-browser-warning': 'true'
                    },
                    body: JSON.stringify({ action: mode }),
                    signal: controller.signal
                });
                
                clearTimeout(timeout);
                const duration = markEnd('API Network Request');
                
                markStart('Response Parse');
                const data = await res.json();
                markEnd('Response Parse');
                
                if (!res.ok) throw new Error(data.message || "Scan Failed");

                // Double-Vibrate for success
                if(navigator.vibrate) navigator.vibrate([50, 50, 50]);
                
                // Sound Effect
                soundManager.play('success');
                
                showResult('success', data.data?.attendeeName || "Valid Ticket", data.message);

                // Auto-dismiss with delay (1.5s) for better UX
                resetState(1500);

            } catch (e) {
                // Long vibrate for error
                if(navigator.vibrate) navigator.vibrate(300);
                
                const errorMsg = e.message ? e.message.toLowerCase() : "unknown error";
                const isCheckedIn = errorMsg.includes('already checked');
                const isLeave = errorMsg.includes('on leave');
                
                if (isCheckedIn) {
                    showResult('warning', 'Already In', 'Ticket Used');
                    soundManager.play('warning');
                } else if (errorMsg.includes('fetch') || errorMsg.includes('network')) {
                    showResult('error', 'Network Error', 'Retrying failed. Check Wi-Fi.');
                    soundManager.play('error');
                } else {
                    showResult('error', 'Invalid', e.message || "Unknown Error");
                    soundManager.play('error');
                }
                resetState(2000); // Keep errors visible longer
            }
        }

        function showResult(type, title, subtitle) {
            const area = document.getElementById('result-area');
            const wrapper = document.getElementById('result-wrapper');
            const card = document.getElementById('result-card');
            const icon = document.getElementById('result-icon');
            const name = document.getElementById('result-name');
            const msg = document.getElementById('result-msg');
            const glow = document.getElementById('result-glow');
            const box = document.getElementById('scan-box');

            area.classList.remove('hidden');
            
            // Reset Animation
            wrapper.classList.remove('popup-enter');
            void wrapper.offsetWidth; // Trigger reflow
            wrapper.classList.add('popup-enter');

            // Configs
            const styles = {
                success: { 
                    glow: 'from-green-500 to-emerald-500', 
                    border: 'border-green-400/50', 
                    icon: '‚ú®',
                    text: 'text-green-100'
                },
                error: { 
                    glow: 'from-red-500 to-rose-500', 
                    border: 'border-red-400/50', 
                    icon: 'üõë',
                    text: 'text-red-100'
                },
                warning: { 
                    glow: 'from-yellow-500 to-amber-500', 
                    border: 'border-yellow-400/50', 
                    icon: '‚ö†Ô∏è',
                    text: 'text-yellow-100'
                },
                loading: { 
                    glow: 'from-blue-500 to-indigo-500', 
                    border: 'border-blue-400/50', 
                    icon: '‚è≥',
                    text: 'text-blue-100'
                }
            };
            
            const s = styles[type] || styles.loading;
            
            // Apply Styles
            glow.className = `absolute inset-0 opacity-20 bg-gradient-to-tr ${s.glow}`;
            card.className = `bg-gray-900/90 backdrop-blur-3xl rounded-[2.3rem] p-6 w-full max-w-sm text-center relative overflow-hidden border ${s.border}`;
            
            icon.innerText = s.icon;
            name.innerText = title;
            msg.innerText = subtitle;
            msg.className = `text-xs font-bold uppercase tracking-[0.2em] bg-white/10 py-1 px-3 rounded-full inline-block backdrop-blur-md ${s.text}`;

            // Update Overlay Box Color
            if (type === 'error') box.classList.add('error');
            if (type === 'success') box.classList.add('active');
        }

        let resetTimer = null;
        function resetState(delay) {
            if (resetTimer) clearTimeout(resetTimer);
            
            resetTimer = setTimeout(() => {
                isProcessing = false;
                document.getElementById('result-area').classList.add('hidden');
                const box = document.getElementById('scan-box');
                box.classList.remove('active', 'error');
            }, delay);
        }

        function updateUI(isConfigured) {
            const badge = document.getElementById('status-badge');
            const dot = document.getElementById('status-dot');
            const text = document.getElementById('event-name');
            const toggle = document.getElementById('mode-toggle');

            if (isConfigured) {
                text.innerText = config.eventId;
                dot.classList.remove('bg-gray-500');
                dot.classList.add('bg-green-400', 'animate-pulse');
                toggle.classList.remove('hidden');
                badge.classList.add('border-green-500/30');
            } else {
                text.innerText = "Not Linked";
                dot.className = "w-2.5 h-2.5 rounded-full bg-red-500 animate-pulse";
                toggle.classList.add('hidden');
            }
        }

        function setMode(m) {
            mode = m;
            const btnIn = document.getElementById('btn-in');
            const btnOut = document.getElementById('btn-out');
            
            const activeClass = "bg-indigo-600 text-white shadow-xl scale-105 z-10";
            const inactiveClass = "text-gray-400 hover:text-white hover:bg-white/5";
            
            if (mode === 'check-in') {
                btnIn.className = `flex-1 py-3 rounded-xl text-sm font-extrabold transition-all ${activeClass}`;
                btnOut.className = `flex-1 py-3 rounded-xl text-sm font-extrabold transition-all ${inactiveClass}`;
            } else {
                btnIn.className = `flex-1 py-3 rounded-xl text-sm font-extrabold transition-all ${inactiveClass}`;
                btnOut.className = `flex-1 py-3 rounded-xl text-sm font-extrabold transition-all bg-pink-600 text-white shadow-xl scale-105 z-10`;
            }
        }

        function resetApp() {
            if (confirm("Unlink scanner from current event?")) {
                localStorage.removeItem('ticketScannerConfig');
                location.reload();
            }
        }

        async function reportIssue() {
            if (!config || !config.eventId) return alert("Link to an event first!");
            
            // Visual feedback
            if (navigator.vibrate) navigator.vibrate(50);
            
            try {
                const res = await fetch(`${config.apiBaseUrl}/api/scanner/report-issue/${config.eventId}`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json', 
                        'Authorization': `Bearer ${config.token}`,
                        'ngrok-skip-browser-warning': 'true'
                    },
                    body: JSON.stringify({ deviceId: 'scanner-web-client' })
                });
                
                const data = await res.json();

                if (res.ok) {
                    showResult('warning', 'Reported', 'Issue notified to dashboard');
                    soundManager.play('warning');
                    setTimeout(() => resetState(0), 1500);
                } else {
                    console.error("Report Error:", data);
                    alert("Failed to report: " + (data.message || "Unknown Server Error"));
                    soundManager.play('error');
                }
            } catch (e) {
                console.error(e);
                alert("Network Error: " + e.message);
                soundManager.play('error');
            }
        }
    </script>
</body>
</html>