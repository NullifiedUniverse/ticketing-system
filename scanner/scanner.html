<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ticket Scanner</title>
    
    <!-- 1. STABLE DEPENDENCIES (Blocking load for reliability) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/html5-qrcode.min.js" onerror="this.src='https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js'"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { background: black; font-family: 'Inter', sans-serif; overflow: hidden; }
        
        /* Camera Background */
        #reader {
            position: fixed; inset: 0; z-index: 0;
            background: black;
        }
        #reader video {
            width: 100% !important; height: 100% !important;
            object-fit: cover !important;
        }

        /* UI Foreground */
        #ui-layer {
            position: fixed; inset: 0; z-index: 10;
            display: flex; flex-direction: column;
            padding: 1.5rem;
            pointer-events: none; /* Let clicks pass through to nothing */
        }
        .interactive { pointer-events: auto; }

        /* Glass Effect */
        .glass {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* Scanner Box */
        .scan-frame {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: min(70vw, 70vh); height: min(70vw, 70vh);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 24px;
            box-shadow: 0 0 0 4000px rgba(0,0,0,0.7); /* Darken surroundings */
            transition: border-color 0.2s;
        }
        .scan-frame.active { border-color: #4ade80; box-shadow: 0 0 0 4000px rgba(0,0,0,0.7), 0 0 30px rgba(74, 222, 128, 0.5); }
        .scan-frame.error { border-color: #ef4444; box-shadow: 0 0 0 4000px rgba(0,0,0,0.7), 0 0 30px rgba(239, 68, 68, 0.5); }

        .corner {
            position: absolute; width: 20px; height: 20px;
            border-color: white; border-style: solid;
        }
        .tl { top: -2px; left: -2px; border-width: 4px 0 0 4px; border-radius: 20px 0 0 0; }
        .tr { top: -2px; right: -2px; border-width: 4px 4px 0 0; border-radius: 0 20px 0 0; }
        .bl { bottom: -2px; left: -2px; border-width: 0 0 4px 4px; border-radius: 0 0 0 20px; }
        .br { bottom: -2px; right: -2px; border-width: 0 4px 4px 0; border-radius: 0 0 20px 0; }

        /* Animations */
        @keyframes scan { 0% { top: 0%; opacity: 0; } 50% { opacity: 1; } 100% { top: 100%; opacity: 0; } }
        .laser {
            position: absolute; left: 10%; right: 10%; height: 2px; background: #6366f1;
            box-shadow: 0 0 15px #6366f1;
            animation: scan 2s infinite ease-in-out;
        }
    </style>
</head>
<body>

    <!-- Camera Container -->
    <div id="reader"></div>

    <!-- UI Layer -->
    <div id="ui-layer">
        
        <!-- Top Bar -->
        <div class="flex justify-between items-start interactive">
            <div class="glass px-4 py-2 rounded-full flex items-center gap-3">
                <div id="status-dot" class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>
                <span id="event-name" class="font-bold text-sm text-white tracking-wide">Setup Required</span>
            </div>
            <button onclick="resetApp()" class="glass p-2 rounded-full text-white/70 hover:text-white transition">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
            </button>
        </div>

        <!-- Center Scanner Visuals -->
        <div class="scan-frame" id="scan-frame">
            <div class="corner tl"></div><div class="corner tr"></div>
            <div class="corner bl"></div><div class="corner br"></div>
            <div class="laser"></div>
        </div>

        <!-- Bottom Controls -->
        <div class="mt-auto space-y-4 interactive">
            
            <!-- Notification Toast -->
            <div id="toast" class="hidden glass p-4 rounded-xl border-l-4 border-blue-500 flex items-center gap-3 transition-all">
                <span id="toast-icon" class="text-xl">ℹ️</span>
                <div>
                    <h3 id="toast-title" class="font-bold text-sm">Info</h3>
                    <p id="toast-msg" class="text-xs text-gray-300">Message</p>
                </div>
            </div>

            <!-- Mode Switcher -->
            <div id="controls" class="hidden flex glass p-1 rounded-xl">
                <button onclick="setMode('check-in')" id="btn-in" class="flex-1 py-3 rounded-lg text-sm font-bold bg-indigo-600 shadow-lg">Check In</button>
                <button onclick="setMode('check-out')" id="btn-out" class="flex-1 py-3 rounded-lg text-sm font-bold text-gray-400">Check Out</button>
            </div>

            <!-- Main Button -->
            <button id="start-btn" onclick="startScanner()" class="w-full bg-white text-black font-bold py-4 rounded-xl shadow-xl active:scale-95 transition disabled:opacity-50">
                Initialize Camera
            </button>
        </div>
    </div>

    <script>
        // --- APP STATE ---
        let html5QrCode;
        let config = null;
        let mode = 'check-in';
        let isProcessing = false;

        // --- INITIALIZATION ---
        window.onload = () => {
            console.log("Window Loaded. Checking lib...");
            if (typeof Html5QrCode === 'undefined') {
                // Retry once via shim
                if (window.__Html5QrcodeLibrary__) window.Html5QrCode = window.__Html5QrcodeLibrary__.Html5Qrcode;
            }

            if (typeof Html5QrCode !== 'undefined') {
                document.getElementById('start-btn').innerText = "Start Camera";
                loadConfig();
            } else {
                document.getElementById('start-btn').innerText = "Lib Failed - Reload";
                document.getElementById('start-btn').onclick = () => location.reload();
            }
        };

        function loadConfig() {
            try {
                const saved = localStorage.getItem('ticketScannerConfig');
                if (saved) {
                    config = JSON.parse(saved);
                    updateUIState(true);
                    // Warmup cache
                    fetch(`${config.apiBaseUrl}/api/scanner/warmup/${config.eventId}`, {
                        headers: { 'Authorization': `Bearer ${config.token}` },
                        keepalive: true
                    }).catch(console.warn);
                }
            } catch(e) {
                localStorage.removeItem('ticketScannerConfig');
            }
        }

        // --- CAMERA ---
        async function startScanner() {
            const btn = document.getElementById('start-btn');
            btn.disabled = true;
            btn.innerText = "Starting...";

            try {
                // Native permission request first
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                stream.getTracks().forEach(t => t.stop()); // Close immediate to release for lib

                html5QrCode = new Html5QrCode("reader");
                
                // Standard config
                await html5QrCode.start(
                    { facingMode: "environment" },
                    { 
                        fps: 20, 
                        qrbox: (w, h) => ({ width: Math.min(w,h)*0.7, height: Math.min(w,h)*0.7 }) 
                    },
                    onScanSuccess,
                    () => {} // Ignore frame errors
                );

                btn.classList.add('hidden'); // Hide button on success
                document.getElementById('scan-frame').classList.remove('hidden');
                
            } catch (err) {
                console.error(err);
                showToast('error', 'Camera Error', err.message || "Permission Denied");
                btn.disabled = false;
                btn.innerText = "Retry Camera";
            }
        }

        async function onScanSuccess(decodedText, decodedResult) {
            if (isProcessing) return;
            isProcessing = true;

            // Freeze UI
            try { html5QrCode.pause(true); } catch(e){}
            document.getElementById('scan-frame').classList.add('active');
            if(navigator.vibrate) navigator.vibrate(50);

            if (!config) {
                await handleSetup(decodedText);
            } else {
                await handleTicket(decodedText);
            }
        }

        // --- LOGIC ---
        async function handleSetup(text) {
            try {
                const data = JSON.parse(text);
                if (!data.eventId || !data.apiBaseUrl) throw new Error("Invalid Config");
                
                config = data;
                localStorage.setItem('ticketScannerConfig', JSON.stringify(config));
                updateUIState(true);
                showToast('success', 'Connected', `Event: ${config.eventId}`);
                
            } catch (e) {
                showToast('error', 'Setup Failed', 'Invalid QR Code');
                document.getElementById('scan-frame').classList.add('error');
            } finally {
                resetScanState();
            }
        }

        async function handleTicket(ticketId) {
            showToast('loading', 'Verifying...', 'Checking server...');
            
            try {
                const controller = new AbortController();
                const id = setTimeout(() => controller.abort(), 5000);

                const res = await fetch(`${config.apiBaseUrl}/api/scanner/update-ticket-status/${config.eventId}/${ticketId}`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${config.token}`
                    },
                    body: JSON.stringify({ action: mode }),
                    signal: controller.signal,
                    keepalive: true
                });
                clearTimeout(id);
                
                const data = await res.json();
                
                if (!res.ok) throw new Error(data.message || "Scan Failed");
                
                showToast('success', 'Valid Ticket', data.message);

            } catch (e) {
                let type = e.message.includes('Checked In') ? 'warning' : 'error';
                showToast(type, type === 'warning' ? 'Warning' : 'Error', e.message);
                document.getElementById('scan-frame').classList.add(type === 'warning' ? 'warning' : 'error');
                if(navigator.vibrate) navigator.vibrate([100,50,100]);
            } finally {
                setTimeout(resetScanState, 750); // Slight delay for user to read
            }
        }

        function resetScanState() {
            isProcessing = false;
            const frame = document.getElementById('scan-frame');
            frame.classList.remove('active', 'error', 'warning');
            try { html5QrCode.resume(); } catch(e){}
        }

        // --- UI UTILS ---
        function updateUIState(configured) {
            if (configured) {
                document.getElementById('event-name').innerText = config.eventId;
                document.getElementById('status-dot').className = "w-2 h-2 rounded-full bg-green-500 animate-pulse";
                document.getElementById('controls').classList.remove('hidden');
            } else {
                document.getElementById('event-name').innerText = "Setup Required";
                document.getElementById('controls').classList.add('hidden');
            }
        }

        function setMode(newMode) {
            mode = newMode;
            const btnIn = document.getElementById('btn-in');
            const btnOut = document.getElementById('btn-out');
            
            if (mode === 'check-in') {
                btnIn.className = "flex-1 py-3 rounded-lg text-sm font-bold bg-indigo-600 text-white shadow-lg transition";
                btnOut.className = "flex-1 py-3 rounded-lg text-sm font-bold text-gray-400 hover:text-white transition";
            } else {
                btnIn.className = "flex-1 py-3 rounded-lg text-sm font-bold text-gray-400 hover:text-white transition";
                btnOut.className = "flex-1 py-3 rounded-lg text-sm font-bold bg-pink-600 text-white shadow-lg transition";
            }
        }

        function showToast(type, title, msg) {
            const el = document.getElementById('toast');
            const colors = {
                success: 'border-green-500 bg-green-900/90',
                error: 'border-red-500 bg-red-900/90',
                warning: 'border-yellow-500 bg-yellow-900/90',
                loading: 'border-blue-500 bg-gray-900/90'
            };
            const icons = { success: '✅', error: '⛔', warning: '⚠️', loading: '⏳' };

            el.className = `glass p-4 rounded-xl border-l-4 flex items-center gap-3 transition-all ${colors[type] || colors.loading}`;
            document.getElementById('toast-icon').innerText = icons[type] || 'ℹ️';
            document.getElementById('toast-title').innerText = title;
            document.getElementById('toast-msg').innerText = msg;
            el.classList.remove('hidden');

            if (type !== 'loading') {
                setTimeout(() => el.classList.add('hidden'), 2000);
            }
        }

        function resetApp() {
            if (confirm("Reset Scanner?")) {
                localStorage.removeItem('ticketScannerConfig');
                location.reload();
            }
        }
    </script>
</body>
</html>